# lexer_parse.c 疑似コード

## 関数: extract_part
- **概要**:
  - 入力文字列から、クォートされた部分または通常の単語部分を抽出する。
- **引数**:
  - `input`: 入力文字列
  - `i`: 現在のインデックスへのポインタ
  - `quote_char`: クォート文字を格納するポインタ
- **処理**:
  1. `'` の場合: `quote_char` に `'` を設定し、`handle_quotes` を呼び出して返す。
  2. `"` の場合: `quote_char` に `"` を設定し、`handle_quotes` を呼び出して返す。
  3. その他: `quote_char` に `0` を設定し、`handle_word` を呼び出して返す。

## 関数: protect_spaces
- **概要**:
  - 文字列内の空白文字を一時的に非表示文字に置換して保護する。
- **引数**:
  - `str`: 処理する文字列
- **処理**:
  1. 文字列を走査する。
  2. 空白文字（スペース、タブ、改行など）を見つけた場合、対応する非表示文字（1〜6）に置換する。

## 関数: process_part
- **概要**:
  - 抽出された部分文字列に対して変数展開と空白保護を行う。
- **引数**:
  - `part`: 部分文字列
  - `quote`: クォートタイプ
  - `data`: シェルの主要データ構造体
- **戻り値**:
  - 処理後の文字列
- **処理**:
  1. シングルクォート以外の場合:
     - `expand_variables` を呼び出し、変数展開を行う。
     - 元の `part` を解放する。
     - ダブルクォートの場合、`protect_spaces` を呼び出して空白を保護する。
     - 展開後の文字列を返す。
  2. シングルクォートの場合:
     - `protect_spaces` を呼び出して空白を保護する。
     - そのまま `part` を返す。

## 関数: handle_word_part
- **概要**:
  - 単語の一部を処理し、変数展開や結合を行う。
- **引数**:
  - `input`: 入力文字列
  - `i`: 現在のインデックスへのポインタ
  - `result`: 結果文字列へのポインタ
  - `data`: シェルの主要データ構造体
- **戻り値**:
  - 成功時: クォートタイプ
  - 失敗時: -1
- **処理**:
  1. `extract_part` で部分文字列を抽出する。
  2. 抽出に失敗した場合 (`NULL`)、-1を返す。
  3. `process_part` で変数展開と空白保護を行う。
  4. `result` と `part` を結合し、新しい文字列を `result` に格納する。
  5. 古い `result` と `part` を解放する。
  6. クォートタイプを返す。

## 関数: build_combined_word
- **概要**:
  - 連続する部分文字列（クォート部分や通常部分）を結合して1つの単語を作成する。
- **引数**:
  - `input`: 入力文字列
  - `i`: 現在のインデックスへのポインタ
  - `quote_type`: クォートタイプを格納するポインタ
  - `data`: シェルの主要データ構造体
- **戻り値**:
  - 結合された単語、またはエラー時 `NULL`
- **処理**:
  1. 結果文字列 `result` を空文字で初期化する。
  2. `has_unquoted` フラグを `0` に初期化する。
  3. `quote_type` を `0` に初期化する。
  4. 区切り文字（`is_separator`）以外が続く間ループする:
     - `handle_word_part` を呼び出し、部分文字列を処理して結合する。
     - `handle_word_part` が失敗した場合 (`-1`):
       - `result` を解放し、`NULL` を返す。
     - クォートタイプを判定し、`has_unquoted` フラグや `quote_type` を更新する。
  5. `has_unquoted` が真なら `quote_type` を `0` に設定する。
  6. `result` を返す。
